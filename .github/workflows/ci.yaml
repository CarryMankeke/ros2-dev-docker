name: CI/CD - ROS 2 Jazzy Build & Lint

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: ros:jazzy-ros-base-noble
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up ROS 2 environment
        run: |
          apt-get update
          apt-get install -y --no-install-recommends \
            python3-colcon-common-extensions \
            python3-rosdep \
            git-all
          rosdep init || true
          rosdep update

      - name: Install dependencies from rosdep
        run: |
          cd ${{ github.workspace }}/ros2_ws
          rosdep install -y --from-paths src --ignore-src --rosdistro jazzy

      - name: Build workspace (colcon)
        run: |
          cd ${{ github.workspace }}/ros2_ws
          source /opt/ros/jazzy/setup.bash
          colcon build --symlink-install --event-handlers console_direct+

      - name: Run ament linters (code style, copyright)
        run: |
          cd ${{ github.workspace }}/ros2_ws
          source /opt/ros/jazzy/setup.bash
          colcon test --packages-select mm_bringup mm_base_description mm_arm_description \
            --event-handlers console_direct+ --return-code-on-test-failure

      - name: Smoke test - modes.launch.py validation
        run: |
          cd ${{ github.workspace }}/ros2_ws
          source /opt/ros/jazzy/setup.bash
          source install/setup.bash
          # Simple test to validate launch file syntax and argument parsing
          ros2 launch mm_bringup modes.launch.py launch_sim:=false launch_display:=false \
            launch_nav2:=false launch_moveit:=false input:=none --show-args 2>&1 | head -20
        continue-on-error: true

      - name: Verify Python shebangs and executability
        run: |
          echo "Checking Python script permissions..."
          find ${{ github.workspace }}/ros2_ws/src -name "*.py" -type f -executable -print | head -10
          
          echo "Verifying all scripts have shebang..."
          for script in ${{ github.workspace }}/ros2_ws/src/mm_bringup/scripts/*.py; do
            if [ -f "$script" ]; then
              head -1 "$script" | grep -q "^#!/usr/bin/env python3" && \
                echo "✓ $script" || echo "✗ $script - missing shebang"
            fi
          done

  lint:
    runs-on: ubuntu-latest
    container:
      image: ros:jazzy-ros-base-noble
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install lint tools
        run: |
          apt-get update
          apt-get install -y --no-install-recommends \
            python3-flake8 \
            python3-pylint \
            python3-autopep8

      - name: Run flake8 on Python files
        run: |
          find ${{ github.workspace }}/ros2_ws/src -name "*.py" -type f \
            -not -path "*/.*" \
            -exec flake8 --max-line-length=120 --ignore=E501,W503 {} +
        continue-on-error: true

      - name: Check YAML formatting
        run: |
          apt-get install -y python3-yaml
          find ${{ github.workspace }}/ros2_ws/src -name "*.yaml" -o -name "*.yml" | \
            xargs python3 -c "import yaml, sys; [yaml.safe_load(open(f)) for f in sys.argv[1:]]" || true
        continue-on-error: true

  report:
    name: Summary
    runs-on: ubuntu-latest
    needs: [ build, lint ]
    if: always()
    
    steps:
      - name: Build status
        run: |
          if [ "${{ needs.build.result }}" = "success" ] && [ "${{ needs.lint.result }}" = "success" ]; then
            echo "✅ All checks passed!"
            exit 0
          else
            echo "⚠️ Some checks failed or had warnings (see logs above)"
            exit 0
          fi
